name: Build & Test

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required for creating releases and uploading assets

env:
  PYTHON_VERSION: '3.11'

jobs:
  test:
    name: Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    if: false  # Temporarily skip tests to expedite release
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 libxcb-xfixes0 libegl1 libgl1

      - name: Run tests
        run: |
          pytest tests/ -v -m "not requires_ollama and not wip" --cov=docprocessor --cov-report=xml --cov-report=term
        env:
          QT_QPA_PLATFORM: offscreen

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: ${{ matrix.os }}
          name: codecov-${{ matrix.os }}
          fail_ci_if_error: false

  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    if: false  # Temporarily skip to expedite release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Check formatting with black
        run: |
          black --check src/ tests/ || echo "::warning::Code formatting issues found. Run 'black src/ tests/' to fix."

      - name: Lint with ruff
        run: |
          ruff check src/ tests/ || echo "::warning::Linting issues found."

      - name: Type check with mypy
        continue-on-error: true
        run: |
          mypy src/ --ignore-missing-imports || echo "::warning::Type checking issues found."

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    # needs: [test, lint]  # Temporarily removed to skip tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[packaging]"

      - name: Install create-dmg
        run: |
          brew install create-dmg

      - name: Build application
        run: |
          python scripts/build_macos.py

      - name: Verify build artifacts
        run: |
          ls -lh dist/
          if [ ! -d "dist/Hrisa Docs.app" ]; then
            echo "Error: App bundle not found"
            exit 1
          fi
          if [ ! -f "dist/HrisaDocs-0.1.0-macOS.dmg" ]; then
            echo "Error: DMG not found"
            exit 1
          fi

      - name: Create checksum
        run: |
          cd dist
          shasum -a 256 HrisaDocs-*.dmg > HrisaDocs-macOS.sha256
          cat HrisaDocs-macOS.sha256

      - name: Upload DMG installer
        uses: actions/upload-artifact@v4
        with:
          name: HrisaDocs-macOS
          path: |
            dist/HrisaDocs-*.dmg
            dist/HrisaDocs-macOS.sha256
          retention-days: 90

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/HrisaDocs-*.dmg
            dist/HrisaDocs-macOS.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    if: false  # Disabled: Linux build done locally due to >2GB GitHub release limit
    # needs: [test, lint]  # Temporarily removed to skip tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo apt-get clean
          echo "Disk space after cleanup:"
          df -h

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 libxcb-cursor0 libegl1 libgl1

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[packaging]"

      - name: Build application
        run: |
          python scripts/build_linux.py

      - name: Verify build artifacts
        run: |
          ls -lh dist/
          if [ ! -f "dist/hrisa-docs-0.1.0-linux-x86_64.tar.gz" ]; then
            echo "Error: Linux tarball not found"
            exit 1
          fi

      - name: Create checksum
        run: |
          cd dist
          sha256sum hrisa-docs-*.tar.gz > hrisa-docs-linux.sha256
          cat hrisa-docs-linux.sha256

      - name: Upload Linux tarball
        uses: actions/upload-artifact@v4
        with:
          name: HrisaDocs-Linux
          path: |
            dist/hrisa-docs-*.tar.gz
            dist/hrisa-docs-linux.sha256
          retention-days: 90

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/hrisa-docs-*.tar.gz
            dist/hrisa-docs-linux.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    # needs: [test, lint]  # Temporarily removed to skip tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[packaging]"

      - name: Install Inno Setup
        run: |
          choco install innosetup -y

      - name: Build application
        run: |
          python scripts/build_windows.py

      - name: Verify build artifacts
        run: |
          dir dist\
          if (-not (Test-Path "dist\HrisaDocs.exe")) {
            Write-Error "Error: Executable not found"
            exit 1
          }
        shell: pwsh

      - name: Create checksum
        run: |
          cd dist
          if (Test-Path "HrisaDocs-*-Setup.exe") {
            Get-FileHash HrisaDocs-*-Setup.exe -Algorithm SHA256 |
              Select-Object @{Name='Hash';Expression={$_.Hash}}, @{Name='File';Expression={Split-Path $_.Path -Leaf}} |
              Format-Table -HideTableHeaders |
              Out-File HrisaDocs-Windows.sha256
            Get-Content HrisaDocs-Windows.sha256
          }
        shell: pwsh

      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: HrisaDocs-Windows
          path: |
            dist/HrisaDocs-*-Setup.exe
            dist/HrisaDocs-Windows.sha256
          retention-days: 90

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/HrisaDocs-*-Setup.exe
            dist/HrisaDocs-Windows.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-macos, build-windows]  # Linux excluded: built locally
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for release notes
        id: check_notes
        run: |
          if [ -f "RELEASE_NOTES_${GITHUB_REF#refs/tags/}.md" ]; then
            echo "has_notes=true" >> $GITHUB_OUTPUT
          else
            echo "has_notes=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        run: |
          if [ "${{ steps.check_notes.outputs.has_notes }}" == "true" ]; then
            cp "RELEASE_NOTES_${GITHUB_REF#refs/tags/}.md" release_notes.md
          else
            echo "# ${GITHUB_REF#refs/tags/}" > release_notes.md
            echo "" >> release_notes.md
            echo "## What's Changed" >> release_notes.md
            echo "" >> release_notes.md
            PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            if [ -n "$PREV_TAG" ]; then
              git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" >> release_notes.md
            else
              git log --pretty=format:"- %s (%h)" >> release_notes.md
            fi
            echo "" >> release_notes.md
            echo "" >> release_notes.md
            echo "## Downloads" >> release_notes.md
            echo "" >> release_notes.md
            echo "### macOS" >> release_notes.md
            echo "- Download: \`HrisaDocs-0.1.0-macOS.dmg\`" >> release_notes.md
            echo "- Requirements: macOS 12.0+ (Monterey)" >> release_notes.md
            echo "" >> release_notes.md
            echo "### Windows" >> release_notes.md
            echo "- Download: \`HrisaDocs-0.1.0-Setup.exe\`" >> release_notes.md
            echo "- Requirements: Windows 10+" >> release_notes.md
            echo "" >> release_notes.md
            echo "## Prerequisites" >> release_notes.md
            echo "- [Ollama](https://ollama.ai/download) (required)" >> release_notes.md
            echo "- Run: \`ollama pull llama3.1:latest\`" >> release_notes.md
          fi

      - name: Update release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
